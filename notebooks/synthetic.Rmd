---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RNAmrf)
source(here::here("R/misc.R"))
```

## generate synthetic seqs

- Rules:
    - 25nt
    - pk

1:4 ~ 15:12
6:9 ~ 22:19

```{r}
# SS
pairs=rep(0,30)

pairs[1:4]=15:12
pairs[6:9]=28:25
pairs

ss=rep(".",30)
ss[1:4]="A"
ss[15:12]="a"
ss[6:9]="("
ss[28:25]=")"

seqss=seqinr::c2s(ss)
seqss
```


```{r}

set.seed(123)
rng_seq=function(pairs=NULL,len=30){
  # myseq=character(25)
  myseq=sample(c("A","U","C","G","-"),len,replace = TRUE, prob=c(1,1,1,1,0.5))
  
  # myseq[11:12]=sample(c("a","u","c","g","."),2,replace = TRUE, prob=c(1,1,1,1,1))
  myseq[18:21]="-"
  myseq[18:21]=sample(c("a","u","c","g","."),4,replace = TRUE, prob=c(1,1,1,1,3))
  
  
  
  ## add pairs
  i=which(pairs>0)
  j=pairs[which(pairs>0)]
  # message(i)
  
  rng_bp=(sample(c("AU", "GC", "CG", "UA"),length(i),replace = TRUE))
  bp_1= gsub("^(.)(.)","\\1",rng_bp)
  bp_2= gsub("^(.)(.)","\\2",rng_bp)
  myseq[i]=bp_1
  myseq[j]=bp_2
  
  return(myseq)
}

seq1=rng_seq(pairs=pairs,len=25)


seqtmp=lapply(1:300,function(i){
 return(rng_seq(pairs=pairs,len=30)) 
})

seqnames=paste0("seq",1:300)

dir.create(here::here("data/synth4/"),recursive=TRUE)

seqtmp[[1]]

seqinr::write.fasta(seqtmp,names=seqnames,file.out=here::here("data/synth4/seq1000_gaps.a2m"))

wd=here::here("data/synth4")

Sys.setenv(mywd=wd)
Sys.setenv(seqss=seqss)
```


```{r}

```

```{bash}
## create afa

cd $mywd

caseid=$(basename $mywd)

#sed 's/-//g' seq1000_gaps.fasta > seq1000_gaps.unaligned.fasta

esl-reformat stockholm seq1000_gaps.a2m > seq1000_gaps.sto.tmp

head -n -1 seq1000_gaps.sto.tmp > seq1000_gaps.sto
echo "#=GC SS_cons $seqss" >> seq1000_gaps.sto
echo "//" >> seq1000_gaps.sto
#esl-reformat stockholm seq1000_gaps.fasta > seq1000_gaps.fasta

cp seq1000_gaps.sto $caseid.sto

cmbuild --hand $caseid.cm $caseid.sto

```



```{bash}
## create ref in a2m format
## require esl-reformat from infernal

cd $mywd
esl-reformat a2m seq1000_gaps.fasta > seq1000_gaps.a2m

esl-reformat stockholm seq1000_gaps.a2m > seq1000_gaps.sto.tmp

head -n -1 seq1000_gaps.sto.tmp > seq1000_gaps.sto
echo "#=GC SS_cons $seqss" >> seq1000_gaps.sto
echo "//" >> seq1000_gaps.sto



```


### mrf from gremlincpp



```{bash}

echo $mywd

cd $mywd
# require gremlin_cpp on path
gremlin_cpp -alphabet rna -i seq1000_gaps.fasta -o seq1000_gaps.fasta.gremlincpp -gap_cutoff 1.0 -mrf_o seq1000_gaps.mrf -gap_cutoff 1.0 > seq1000_gaps.fasta.gremlin.log

```

