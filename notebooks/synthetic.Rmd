---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RNAmrf)
source(here::here("R/misc.R"))
```

## R Markdown

- Rules:
    - 25nt
    - pk

1:4 ~ 15:12
6:9 ~ 22:19

```{r}
pairs=rep(0,25)

pairs[1:4]=15:12
pairs[6:9]=22:19
pairs

ss=rep(".",25)
ss[1:4]="("
ss[15:12]=")"
ss[6:9]="A"
ss[22:19]="a"

seqinr::c2s(ss)
```


```{r}



rng_seq=function(pairs=NULL,len=25){
  # myseq=character(25)
  myseq=sample(c("a","u","c","g","-"),25,replace = TRUE)
  
  
  ## add pairs
  i=which(pairs>0)
  j=pairs[which(pairs>0)]
  # message(i)
  
  rng_bp=tolower(sample(c("AU", "GC", "CG", "UA"),length(i),replace = TRUE))
  bp_1= gsub("^(.)(.)","\\1",rng_bp)
  bp_2= gsub("^(.)(.)","\\2",rng_bp)
  myseq[i]=bp_1
  myseq[j]=bp_2
  
  return(myseq)
}

seq1=rng_seq(pairs=pairs,len=25)

set.seed(42)
seqtmp=lapply(1:1000,function(i){
 return(rng_seq(pairs=pairs,len=25)) 
})

seqnames=paste0("seq",1:1000)

seqinr::write.fasta(seqtmp,names=seqnames,file.out=here::here("data/synth/seq1000_gaps.fasta"))
```


### mrf

```{r}
mrf=RNAmrf::read_mrf_renum("../data/synth/seq1000.mrf")
```

```{r}
library(RNAmrf)
```


```{r}
gg_mat(mrf$mrf_h)
gg_mat(mrf$mat_apc)
```


#### gaps

```{r}
mrf1=RNAmrf::read_mrf_renum("../data/synth/seq1000_gaps.afa.mrf")

mrfcm=RNAmrf::read_mrf_renum("../data/synth/seq1000_gaps_rmgp.fasta.cmaln.sto.afa.mrf")

gg_mat(mrf1$mat_apc)

gg_mat(mrfcm$mat_apc)
```

####



```{r}
seqtmp=seqinr::read.fasta("/home/tc/GIT/RNA_PKALN/data/synth/seq1000_gaps.afa")
```







### debug



```{r}

iteration=10
wt_h=.001
wt_j=1.0
gap_ext=0.1
gap_open=-5
seq=seqtmp[[6]]
debug=TRUE

mrf=mrf1

  exp_seq = RNAmrf:::encode_seq(seq)

  SCO_init = RNAmrf:::ini_SCO_simple(exp_seq$seq_int_ungapped,
                            mrf_h = mrf$mrf_h)
  
  SCO_init2=RNAmrf:::ini_SCO(exp_seq$seq_int_ungapped,
                             mrf_mat = mrf$mrf_mat,
                             mrf_h = mrf$mrf_h)
  
  SCO_mod = RNAmrf:::mod_SCO(
    SCO_init2,
    iteration = iteration,
    exp_seq$seq_int_ungapped,
    mrf_mat = mrf$mrf_mat,
    mrf_h = mrf$mrf_h,
    wt_h = wt_h,
    wt_j = wt_j,
    gap_o=gap_open,
    gap_e=gap_ext,
    DEBUG = debug
  )
  # 
  a2b=RNAmrf:::align(SCO_mod,gap_ext = gap_ext,gap_open = gap_open)
  # # return(a2b)
  a2b

gg_mat(SCO_mod)

gg_mat(SCO_init)
gg_mat(SCO_init2)
```



```{r}
seq1=seqtmp[[1]]
seq1enc=encode_seq(seq1)
seq1enc

RNAmrf:::score_aln(seq1enc$seq_int_ref-1,seq=seq1enc$seq_int_ungapped,mrf_mat = mrf$mrf_mat,mrf_h = mrf$mrf_h,DEBUG = TRUE)
```


