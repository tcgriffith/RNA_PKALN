---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RNAmrf)
source(here::here("R/misc.R"))
```

## generate synthetic seqs

- Rules:
    - 25nt
    - pk

1:4 ~ 15:12
6:9 ~ 22:19

```{r}
# SS
pairs=rep(0,25)

pairs[1:4]=15:12
pairs[6:9]=22:19
pairs

ss=rep(".",25)
ss[1:4]="("
ss[15:12]=")"
ss[6:9]="A"
ss[22:19]="a"

seqss=seqinr::c2s(ss)
seqss
```


```{r}

set.seed(123)
rng_seq=function(pairs=NULL,len=25){
  # myseq=character(25)
  myseq=sample(c("A","U","C","G","-"),25,replace = TRUE, prob=c(1,1,1,1,0.5))
  
  
  ## add pairs
  i=which(pairs>0)
  j=pairs[which(pairs>0)]
  # message(i)
  
  rng_bp=(sample(c("AU", "GC", "CG", "UA"),length(i),replace = TRUE))
  bp_1= gsub("^(.)(.)","\\1",rng_bp)
  bp_2= gsub("^(.)(.)","\\2",rng_bp)
  myseq[i]=bp_1
  myseq[j]=bp_2
  
  return(myseq)
}

seq1=rng_seq(pairs=pairs,len=25)


seqtmp=lapply(1:1000,function(i){
 return(rng_seq(pairs=pairs,len=25)) 
})

seqnames=paste0("seq",1:1000)

dir.create(here::here("data/synth/"),recursive=TRUE)

seqtmp[[1]]

seqinr::write.fasta(seqtmp,names=seqnames,file.out=here::here("data/synth/seq1000_gaps.fasta"))
```


```{r}
wd=here::here("data/synth")

Sys.setenv(mywd=wd)
Sys.setenv(seqss=seqss)
```

```{bash}
## create afa

cd $mywd

sed 's/-//g' seq1000_gaps.fasta > seq1000_gaps.unaligned.fasta

#esl-reformat stockholm seq1000_gaps.fasta > seq1000_gaps.fasta

```



```{bash}
## create ref in a2m format
## require esl-reformat from infernal

cd $mywd
esl-reformat a2m seq1000_gaps.fasta > seq1000_gaps.a2m

esl-reformat stockholm seq1000_gaps.a2m > seq1000_gaps.sto.tmp

head -n -1 seq1000_gaps.sto.tmp > seq1000_gaps.sto
echo "#=GC SS_cons $seqss" >> seq1000_gaps.sto
echo "//" >> seq1000_gaps.sto



```


### mrf from gremlincpp



```{bash}

echo $mywd

cd $mywd
# require gremlin_cpp on path
gremlin_cpp -alphabet rna -i seq1000_gaps.fasta -o seq1000_gaps.fasta.gremlincpp -gap_cutoff 1.0 -mrf_o seq1000_gaps.mrf -gap_cutoff 1.0 > seq1000_gaps.fasta.gremlin.log

```

